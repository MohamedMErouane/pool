<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <title>Classic Pool Game</title>
    <link rel="stylesheet" type="text/css" href="css/game-layout.css"/>
    <link rel="shortcut icon" type="image/png" href="assets/sprites/favicon.png"/>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Solana Web3.js for real wallet integration -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <script src="script/lib/LAB.min.js"></script>
    
    <script>
        // Global multiplayer variables
        let socket = null;
        let mySocketId = null;
        let myTurn = false;
        let currentRoomCode = null;
        let isMultiplayer = false;

        $LAB
            .script('script/system/Keys.js').wait()
            .script('script/system/Color.js').wait()
            .script('script/geom/Vector2.js').wait()
            .script('script/input/ButtonState.js').wait()
            .script('script/input/Keyboard.js').wait()
            .script('script/input/Mouse.js').wait()
            .script('script/Global.js').wait()
            .script('script/Canvas2D.js').wait()
            .script('script/game_objects/Score.js').wait()
            .script('script/game_objects/Ball.js').wait()
            .script('script/game_objects/Stick.js').wait()
            .script('script/menu/Label.js').wait()
            .script('script/menu/Button.js').wait()
            .script('script/menu/Menu.js').wait()
            .script('script/menu/MainMenu.js').wait()
            .script('script/AI/Opponent.js').wait()
            .script('script/AI/AIPolicy.js').wait()
            .script('script/AI/AITrainer.js').wait()
            .script('script/game_objects/Player.js').wait()
            .script('script/GamePolicy.js').wait()
            .script('script/GameWorld.js').wait()
            .script('script/DailyRewards.js').wait()
            .script('script/HeatMeter.js').wait()
            .script('script/MiniGames.js').wait()
            .script('script/SolanaWallet.js').wait()
            .script('script/RewardsDashboard.js').wait()
            .script('script/Game.js').wait()
            .script('script/Assets.js').wait(function () {
                // Initialize socket connection
                socket = io('http://localhost:3008');
                
                // Setup socket events
                socket.on('connect', () => {
                    mySocketId = socket.id;
                    console.log("Connected:", mySocketId);
                });

                socket.on('waitingForOpponent', () => {
                    document.getElementById('status').textContent = "Waiting for opponent...";
                });

                socket.on('startGame', ({ roomCode, firstTurn, player1Id, player2Id }) => {
    isMultiplayer = true;
    document.getElementById('status').textContent = "Game started!";

    // Set match metadata
    const matchId = `match-${Date.now()}`;

    // Save match to backend
    fetch("http://localhost:3001/matches/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            player1Id: player1Id,  // should be actual UUIDs
            player2Id: player2Id,
            matchId: matchId
        }),
    })
    .then(res => res.json())
    .then(data => console.log("Match saved:", data))
    .catch(err => console.error("Error saving match:", err));

    // Start the game
    AI_ON = false;
    Game.mainMenu.active = false;
    GAME_STOPPED = false;
    
    setTimeout(() => {
        Game.startNewGame();
        if (Game.mainMenu.sound) sounds.fadeOut(Game.mainMenu.sound);
    }, 200);

    myTurn = (firstTurn === mySocketId);
    currentRoomCode = roomCode;
    updateTurnUI();
});

                socket.on('opponentShot', ({ shotData, nextTurn }) => {
                    if (!isMultiplayer) return;
                    
                    myTurn = (nextTurn === mySocketId);
                    updateTurnUI();
                    
                    // Apply opponent's shot to your game world
                    Game.gameWorld.applyShot(shotData);
                });

                // Start the game
                Game.start('gameArea', 'screen', 1500, 825);
            });

        function startMultiplayer() {
            if (!socket || !socket.connected) {
                alert("Not connected to server!");
                return;
            }
            socket.emit('findMatch');
            document.getElementById('status').textContent = "Looking for opponent...";
        }

        function updateTurnUI() {
            const status = document.getElementById('turn-status');
            if (status) {
                status.textContent = myTurn ? "Your Turn" : "Opponent's Turn";
                status.style.color = myTurn ? "green" : "red";
            }
        }

        // This function should be called when the player takes a shot
        function onPlayerShot(shotData) {
            if (!isMultiplayer || !myTurn || !currentRoomCode) return;
            
            socket.emit('playerShot', { 
                roomCode: currentRoomCode, 
                shotData: shotData 
            });
            
            myTurn = false;
            updateTurnUI();
            
            // Apply your own shot locally
            Game.gameWorld.applyShot(shotData);
        }
    </script>
</head>

<body style="background-color:black">
    <!-- Rewards Dashboard Button -->
    <button class="rewards-btn" onclick="rewardsDashboard.toggle()">ðŸŽ¯ Rewards</button>
    
    <!-- Mini Heat Meter Display -->
    <div class="mini-heat-meter" id="mini-heat-meter">
        <div class="mini-heat-display">
            <span class="mini-heat-text">Heat</span>
            <div class="mini-heat-bar">
                <div class="mini-heat-fill" style="width: 0%; background-color: #9E9E9E;"></div>
            </div>
        </div>
    </div>
    
    <div id="gameArea">
        <canvas id="screen" width="2000" height="1000"></canvas>
    </div>
    
    <script>
        // Initialize mini heat meter update
        function updateMiniHeatMeter() {
            const heatStats = GlobalHeatMeter.getStats();
            const miniMeter = document.getElementById('mini-heat-meter');
            if (miniMeter) {
                const fill = miniMeter.querySelector('.mini-heat-fill');
                const text = miniMeter.querySelector('.mini-heat-text');
                
                fill.style.width = heatStats.progress + '%';
                fill.style.backgroundColor = heatStats.color;
                text.textContent = `Heat ${heatStats.currentHeat.toFixed(0)}`;
            }
        }
        
        // Update mini heat meter every 10 seconds
        setInterval(updateMiniHeatMeter, 10000);
        
        // Initial update after 2 seconds to ensure scripts are loaded
        setTimeout(updateMiniHeatMeter, 2000);
    </script>
</body>
</html>